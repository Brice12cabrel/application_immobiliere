<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - MonApp</title>
  <link rel="stylesheet" href="css/themes/midnight.css">
  <link rel="stylesheet" href="css/neu-auth.css">
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0d1117; color: #e6edf3; display: flex; height: 100vh; overflow: hidden; }
    .sidebar {
      width: 280px; background: #161b22; padding: 30px 20px; box-shadow: 8px 0 20px rgba(0,0,0,0.4);
      display: flex; flex-direction: column; gap: 12px;
    }
    .logo { font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 40px;
      background: linear-gradient(135deg, #ff6b6b, #feca57); -webkit-background-clip: text; color: transparent;
    }
    .menu-item {
      padding: 16px 20px; border-radius: 16px; cursor: pointer; transition: all 0.3s;
      box-shadow: inset 6px 6px 12px rgba(0,0,0,0.4), inset -6px -6px 12px rgba(255,255,255,0.03);
      font-weight: 600; display: flex; align-items: center; gap: 14px;
    }
    .menu-item:hover { transform: translateY(-2px); box-shadow: 8px 8px 16px rgba(0,0,0,0.3), -4px -4px 12px rgba(255,255,255,0.05); }
    .menu-item.active { background: #ff6b6b; color: white; box-shadow: 8px 8px 16px rgba(0,0,0,0.3); }
    .main-content { flex: 1; padding: 40px; overflow-y: auto; }
    .welcome { font-size: 32px; margin-bottom: 30px; text-align: center; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card {
      background: #161b22; padding: 24px; border-radius: 20px;
      box-shadow: 8px 8px 16px rgba(0,0,0,0.3), -4px -4px 12px rgba(255,255,255,0.05);
      text-align: center;
    }
    .stat-number { font-size: 36px; font-weight: 800; margin: 10px 0; }
    .section { background: #161b22; padding: 30px; border-radius: 20px; margin-bottom: 30px;
      box-shadow: 8px 8px 16px rgba(0,0,0,0.3), -4px -4px 12px rgba(255,255,255,0.05);
    }
    .pending-list { list-style: none; padding: 0; }
    .pending-item {
      padding: 16px; background: #21262d; border-radius: 16px; margin-bottom: 12px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: inset 6px 6px 12px rgba(0,0,0,0.4);
    }
    .btn-approve { background: #50fa7b; color: black; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }
    .btn-reject { background: #f85149; color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }
    .switch-dashboard {
      position: fixed; top: 20px; right: 20px; background: #58a6ff; color: white;
      padding: 12px 24px; border-radius: 16px; cursor: pointer; font-weight: bold;
      box-shadow: 8px 8px 16px rgba(0,0,0,0.3); z-index: 1000;
    }
  </style>
</head>
<body>

  <div class="switch-dashboard" onclick="goToUserDashboard()">
    Voir comme locataire
  </div>

  <div class="sidebar">
    <div class="logo">Admin</div>
    <div class="menu-item active">Demandes bailleurs</div>
    <div class="menu-item">Utilisateurs</div>
    <div class="menu-item">Annonces</div>
    <div class="menu-item">Statistiques</div>
  </div>

  <div class="main-content">
    <h1 class="welcome">Panneau d'administration</h1>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-users">—</div>
        <div>Utilisateurs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-bailleur">—</div>
        <div>Demandes en attente</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-listings">—</div>
        <div>Annonces</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-revenue">0 FCFA</div>
        <div>Revenus</div>
      </div>
    </div>

    <div class="section">
      <h2>Demandes de bailleurs en attente</h2>
      <ul class="pending-list" id="pending-list">
        <li class="pending-item">Chargement...</li>
      </ul>
    </div>
  </div>

<script>
// PROTECTION TOTALE : ACCÈS ADMIN UNIQUEMENT
function protectAdminDashboard() {
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Accès refusé : non connecté');
    window.location.href = 'index.html';
    return;
  }

  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    
    // Vérifie que le rôle est bien "admin"
    if (payload.role !== 'admin') {
      alert('Accès refusé : vous n\'êtes pas administrateur');
      window.location.href = 'dashboard.html'; // ou index.html
      return;
    }

    // Optionnel : vérifier l'expiration du token
    if (payload.exp && Date.now() >= payload.exp * 1000) {
      alert('Session expirée. Veuillez vous reconnecter.');
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }
  } catch (e) {
    alert('Token invalide');
    localStorage.removeItem('token');
    window.location.href = 'index.html';
  }
}

// Exécute la protection dès le chargement
protectAdminDashboard();

  const token = localStorage.getItem('token');
  if (!token) {
    alert('Accès refusé');
    window.location.href = 'index.html';
  }

  // Vérifie que c'est un admin
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload.role !== 'admin') {
      alert('Accès admin uniquement');
      window.location.href = 'dashboard.html';
    }
  } catch (e) {
    window.location.href = 'index.html';
  }

  // Charger les demandes bailleurs
  async function loadPendingBailleur() {
    try {
      const res = await fetch('http://127.0.0.1:8000/api/admin/pending-bailleur/', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const users = await res.json();

      const list = document.getElementById('pending-list');
      if (users.length === 0) {
        list.innerHTML = '<li class="pending-item">Aucune demande en attente</li>';
        document.getElementById('pending-bailleur').textContent = '0';
        return;
      }

      document.getElementById('pending-bailleur').textContent = users.length;

      list.innerHTML = users.map(u => `
        <li class="pending-item">
          <div>
            <strong>${u.email}</strong><br>
            <small>${u.adresse}, ${u.ville}</small><br>
            <a href="${u.cni_document}" target="_blank">Voir CNI</a> | 
            <a href="${u.titre_foncier}" target="_blank">Voir titre</a>
          </div>
          <div>
            <button class="btn-approve" onclick="approveBailleur(${u.id})">Approuver</button>
            <button class="btn-reject" onclick="rejectBailleur(${u.id})">Rejeter</button>
          </div>
        </li>
      `).join('');
    } catch (err) {
      console.error(err);
    }
  }

  async function approveBailleur(userId) {
    if (!confirm('Approuver ce bailleur ?')) return;
    // À implémenter plus tard
    alert('Fonctionnalité à venir (ou via /admin)');
  }

  function goToUserDashboard() {
    window.location.href = 'dashboard.html';
  }

  loadPendingBailleur();
</script>
</body>
</html>